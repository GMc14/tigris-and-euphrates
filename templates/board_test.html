<html>
<head>
</head>
<script type="text/javascript" src="http://localhost/media/js/jquery-1.2.6.js"></script>
<script type="text/javascript" src="http://localhost/media/js/ui.core.js"></script>
<script type="text/javascript" src="http://localhost/media/js/ui.draggable.js"></script>
<script type="text/javascript" src="http://localhost/media/js/ui.droppable.js"></script>

<script>
var state;

function json_callback(data) {
  $.each(data['player_hand'], function(i, item) { set_civilization_tiles(i, item); });
  $.each(data['temple_civ'], function(i, cell_no) { place_civ_on_board('civ-temple', cell_no); });
  $.each(data['settlement_civ'], function(i, cell_no) { place_civ_on_board('civ-settlement', cell_no); });
  $.each(data['farm_civ'], function(i, cell_no) { place_civ_on_board('civ-farm', cell_no); });
  $.each(data['merchant_civ'], function(i, cell_and_player_no) { place_civ_on_board('civ-merchant', cell_and_player_no); });
  $.each(data['temple_ruler'], function(i, cell_and_player_no) { place_ruler_on_board('ruler-temple', cell_and_player_no); });
  $.each(data['settlement_ruler'], function(i, cell_and_player_no) { place_ruler_on_board('ruler-settlement', cell_and_player_no); });
  $.each(data['farm_ruler'], function(i, cell_and_player_no) { place_ruler_on_board('ruler-farm', cell_and_player_no); });
  $.each(data['merchant_ruler'], function(i, cell_no) { place_ruler_on_board('ruler-merchant', cell_no); });

  state = data;
}

function place_civ_on_board(civ_type, cell_no) {
  $("#drop" + cell_no).removeClass('civ-temple').removeClass('civ-settlement').removeClass('civ-farm').removeClass('civ-merchant').addClass(civ_type);
}

function place_ruler_on_board(ruler_type, cell_info) {
  $("#drop" + cell_info[0]).removeClass('civ-temple').removeClass('civ-settlement').removeClass('civ-farm').removeClass('civ-merchant').addClass(ruler_type + "-" + cell_info[1]);
}

function set_civilization_tiles(index, civ_type) {
  color = 'error';
  type = 'ground';
  if (civ_type[0] == 'f') {
    color = 'civ-farm';
    type = 'river';
  } else if (civ_type[0] == 't') {
    color = 'civ-temple';
  } else if (civ_type[0] == 'm') {
    color = 'civ-merchant';
  } else if (civ_type[0] == 's') {
    color = 'civ-settlement';
  }

  $("#hand" + index).removeAttr('class').addClass('civ').addClass(color).addClass(type).addClass('piece');
}

function config_accept(item, class) {
}

function call_json() {
  $.getJSON("http://localhost:8000/game_state_json/{{ player_no }}/", function (data) { json_callback(data); });
}

  $(document).ready(function(){
    call_json();

    $("#hand0").draggable({revert: true});
    $("#hand1").draggable({revert: true});
    $("#hand2").draggable({revert: true});
    $("#hand3").draggable({revert: true});
    $("#hand4").draggable({revert: true});
    $("#hand5").draggable({revert: true});

    $("#ruler-settlement").draggable({revert: true});
    $("#ruler-farm").draggable({revert: true});
    $("#ruler-merchant").draggable({revert: true});
    $("#ruler-temple").draggable({revert: true});

    $("#board").droppable({
      accept: ".piece",
      drop: function(ev, ui) {
          var row = ev.clientY / {{ size }} | 0;
          var col = ev.clientX / {{ size }} | 0;
          var cell_no = row * {{ cols }} + col;
          
          var piece = ui.draggable.get(0).id;
          var index = -1;
          var war_index = -1;
          if ((['hand0', 'hand1', 'hand2', 'hand3', 'hand4', 'hand5']).indexOf(piece) >= 0) {
             if (ui.draggable.hasClass("ground")) {
                index = state['legal_ground_moves'].indexOf(cell_no);
                war_index = state['war_ground_moves'].indexOf(cell_no);
             }
             else {
                index = state['legal_river_moves'].indexOf(cell_no);
             }

             if (index >= 0) {
                $.getJSON("http://localhost:8000/drop_civ/{{ player_no }}/" + piece + "/" + cell_no + "/", function (data) { json_callback(data); });
             }
             else if (war_index >= 0) {
                alert("WAR, WHAT IS IT GOOD FOR??");
             }
          }
          else {
             switch (piece) {
               case "ruler-settlement":
                 index = state['legal_ruler_moves']['settlement'].indexOf(cell_no);
                 break;
               case "ruler-merchant":
                 index = state['legal_ruler_moves']['merchant'].indexOf(cell_no);
                 break;
               case "ruler-farm":
                 index = state['legal_ruler_moves']['farm'].indexOf(cell_no);
                 break;
               case "ruler-temple":
                 index = state['legal_ruler_moves']['temple'].indexOf(cell_no);
                 break;

               default:
                 index = -1;
             }

             if (index >= 0) {
                $.getJSON("http://localhost:8000/drop_ruler/{{ player_no }}/" + piece.substring(6) + "/" + cell_no + "/", function (data) { json_callback(data); });
             }
          }
      }
    });

  });
  
{% for js in js_script %}
   {{ js }}
{% endfor %}
</script>

<style>
{% for css in css_classes %}
   {{ css }}
{% endfor %}

{{ board_css }}

.cell-ground {
  border: 1px solid white;
  background-color: #887733;
}
.cell-river {
  border: 1px solid white;
  background-color: #7777FF;
}

.droppable-active {
}

.droppable-hover {
   background-color: yellow;
}

#hand0 {
  position: absolute;
  top: 600px;
  left: 200px;
  height: 50px;
  width: 50px;
}

#hand1 {
  position: absolute;
  top: 600px;
  left: 250px;
  height: 50px;
  width: 50px;
}

#hand2 {
  position: absolute;
  top: 600px;
  left: 300px;
  height: 50px;
  width: 50px;
}

#hand3 {
  position: absolute;
  top: 600px;
  left: 350px;
  height: 50px;
  width: 50px;
}

#hand4 {
  position: absolute;
  top: 600px;
  left: 400px;
  height: 50px;
  width: 50px;
}

#hand5 {
  position: absolute;
  top: 600px;
  left: 450px;
  height: 50px;
  width: 50px;
}

#ruler-settlement {
  position: absolute;
  top: 650px;
  left: 250px;
  height: 50px;
  width: 50px;
  background-image: url(http://localhost/media/pieces/rulers/{{ ruler_prefix }}-Settlement.png);
}

#ruler-temple {
  position: absolute;
  top: 650px;
  left: 300px;
  height: 50px;
  width: 50px;
  background-image: url(http://localhost/media/pieces/rulers/{{ ruler_prefix }}-Temple.png);
}

#ruler-merchant {
  position: absolute;
  top: 650px;
  left: 350px;
  height: 50px;
  width: 50px;
  background-image: url(http://localhost/media/pieces/rulers/{{ ruler_prefix }}-Merchant.png);
}

#ruler-farm {
  position: absolute;
  top: 650px;
  left: 400px;
  height: 50px;
  width: 50px;
  background-image: url(http://localhost/media/pieces/rulers/{{ ruler_prefix }}-Farm.png);
}

.piece {
  width: 50px;
  height: 50px;
  z-index:20;
}

.civ-settlement {
  background-color: black;
}

.civ-temple {
  background-color: red;
}

.civ-merchant {
  background-color: green;
}

.civ-farm {
  background-color: blue;
}

.ruler-settlement-1 {
  background-image: url(http://localhost/media/pieces/rulers/A-Settlement.png);
}

.ruler-farm-1 {
  background-image: url(http://localhost/media/pieces/rulers/A-Farm.png);
}

.ruler-merchant-1 {
  background-image: url(http://localhost/media/pieces/rulers/A-Merchant.png);
}

.ruler-temple-1 {
  background-image: url(http://localhost/media/pieces/rulers/A-Temple.png);
}

.ruler-settlement-2 {
  background-image: url(http://localhost/media/pieces/rulers/B-Settlement.png);
}

.ruler-farm-2 {
  background-image: url(http://localhost/media/pieces/rulers/B-Farm.png);
}

.ruler-merchant-2 {
  background-image: url(http://localhost/media/pieces/rulers/B-Merchant.png);
}

.ruler-temple-2 {
  background-image: url(http://localhost/media/pieces/rulers/B-Temple.png);
}


</style>

<body>

<div id="hand0" class="piece civ-settlement">A</div>
<div id="hand1" class="piece civ-temple">B</div>
<div id="hand2" class="piece civ-farm">C</div>
<div id="hand3" class="piece civ-merchant">D</div>
<div id="hand4" class="piece">E</div>
<div id="hand5" class="piece">F</div>
<div id="ruler-settlement" class="ruler-settlement-{{ player_no }} piece"></div>
<div id="ruler-farm" class="ruler-farm-{{ player_no }} piece"></div>
<div id="ruler-merchant" class="ruler-merchant-{{ player_no }} piece"></div>
<div id="ruler-temple" class="ruler-temple-{{ player_no }} piece"></div>

<div id="board">
{% for div in div_decls %}
   {{ div }}
{% endfor %}
</div>

</body>
</html>
